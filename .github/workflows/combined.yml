name: Combined CI/CD and Publish Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]
  workflow_dispatch:
  release:
    types: [ created ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    env:
      TEST_PRIVATE_KEY: ${{ secrets.TEST_PRIVATE_KEY }}
      TEST_USER_KEY: ${{ secrets.TEST_USER_KEY }}
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:ci
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: |
            test-results.xml
            test-report/
            coverage/coverage-summary.json
          retention-days: 30
      
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf
        with:
          files: test-results.xml
          check_name: Test Results (Node ${{ matrix.node-version }})
          comment_mode: always
          report_individual_runs: true

  coverage-summary:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: coverage-artifacts
      
      - name: Display test coverage
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Debug: Show what we're working with
          echo "=== DEBUG INFO ==="
          echo "Current directory: $(pwd)"
          echo ""
          echo "Directory structure:"
          ls -la coverage-artifacts/ 2>/dev/null || echo "coverage-artifacts directory not found"
          echo ""
          echo "All files in coverage-artifacts:"
          find coverage-artifacts -type f 2>/dev/null | head -20 || echo "No files found"
          echo ""
          echo "All directories in coverage-artifacts:"
          find coverage-artifacts -type d 2>/dev/null || echo "No directories found"
          echo ""
          echo "All coverage-summary.json files:"
          find coverage-artifacts -name "coverage-summary.json" -type f 2>/dev/null || echo "No coverage-summary.json files found"
          echo "=================="
          echo ""
          
          # Function to display coverage table
          display_coverage() {
            local COVERAGE_FILE=$1
            local NODE_VERSION=$2
            
            if [ -f "$COVERAGE_FILE" ]; then
              echo "### Node.js $NODE_VERSION" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "File             | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s" >> $GITHUB_STEP_SUMMARY
              echo "-----------------|---------|----------|---------|---------|-------------------" >> $GITHUB_STEP_SUMMARY
              
              node -e "
                const fs = require('fs');
                const path = require('path');
                const data = JSON.parse(fs.readFileSync('$COVERAGE_FILE', 'utf8'));
                const files = Object.keys(data).filter(k => k !== 'total').sort();
                const total = data.total;
                console.log(\`All files        | \${String(total.statements.pct).padStart(6)} | \${String(total.branches.pct).padStart(8)} | \${String(total.functions.pct).padStart(7)} | \${String(total.lines.pct).padStart(7)} |\`);
                files.forEach(file => {
                  const fileName = path.basename(file);
                  const fileData = data[file];
                  const uncovered = fileData.lines.notCovered && Array.isArray(fileData.lines.notCovered) && fileData.lines.notCovered.length > 0 ? fileData.lines.notCovered.join(',') : '';
                  console.log(\` \${fileName.padEnd(15)} | \${String(fileData.statements.pct).padStart(6)} | \${String(fileData.branches.pct).padStart(8)} | \${String(fileData.functions.pct).padStart(7)} | \${String(fileData.lines.pct).padStart(7)} | \${uncovered}\`);
                });
              " >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          }
          
          # Find coverage files - check in subdirectories first (artifact names)
          COVERAGE_20=""
          COVERAGE_18=""
          
          echo "Searching for Node 20.x coverage..."
          if [ -d "coverage-artifacts/test-results-20.x" ]; then
            echo "Found directory: coverage-artifacts/test-results-20.x"
            COVERAGE_20=$(find coverage-artifacts/test-results-20.x -name "coverage-summary.json" -type f | head -1)
            echo "Result: $COVERAGE_20"
          else
            echo "Directory not found: coverage-artifacts/test-results-20.x"
          fi
          
          echo "Searching for Node 18.x coverage..."
          if [ -d "coverage-artifacts/test-results-18.x" ]; then
            echo "Found directory: coverage-artifacts/test-results-18.x"
            COVERAGE_18=$(find coverage-artifacts/test-results-18.x -name "coverage-summary.json" -type f | head -1)
            echo "Result: $COVERAGE_18"
          else
            echo "Directory not found: coverage-artifacts/test-results-18.x"
          fi
          
          # If not found in subdirectories, search all files and match by path
          if [ -z "$COVERAGE_20" ]; then
            echo "Trying alternative search for 20.x..."
            COVERAGE_20=$(find coverage-artifacts -name "coverage-summary.json" -type f | grep -i "20" | head -1)
            echo "Alternative result: $COVERAGE_20"
          fi
          
          if [ -z "$COVERAGE_18" ]; then
            echo "Trying alternative search for 18.x..."
            COVERAGE_18=$(find coverage-artifacts -name "coverage-summary.json" -type f | grep -i "18" | head -1)
            echo "Alternative result: $COVERAGE_18"
          fi
          
          echo ""
          echo "Final results:"
          echo "COVERAGE_20: $COVERAGE_20"
          echo "COVERAGE_18: $COVERAGE_18"
          echo ""
          
          # Display coverage for found versions
          if [ -n "$COVERAGE_20" ] && [ -f "$COVERAGE_20" ]; then
            echo "Displaying Node 20.x coverage..."
            display_coverage "$COVERAGE_20" "20.x"
          else
            echo "Node 20.x coverage file not found or not readable"
          fi
          
          if [ -n "$COVERAGE_18" ] && [ -f "$COVERAGE_18" ]; then
            echo "Displaying Node 18.x coverage..."
            display_coverage "$COVERAGE_18" "18.x"
          else
            echo "Node 18.x coverage file not found or not readable"
          fi
          
          # Fallback if no version-specific files found
          if [ -z "$COVERAGE_20" ] && [ -z "$COVERAGE_18" ]; then
            echo "No version-specific files found, trying fallback..."
            COVERAGE_FILE=$(find coverage-artifacts -name "coverage-summary.json" -type f | head -1)
            echo "Fallback file: $COVERAGE_FILE"
            if [ -f "$COVERAGE_FILE" ]; then
              display_coverage "$COVERAGE_FILE" "Unknown"
            else
              echo "Coverage data not found" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  update-version-and-publish:
    name: Update Version and Publish to NPM
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update package.json version
        run: |
          TAG_NAME=$(echo ${{github.ref_name}})          
          jq --arg tag "$TAG_NAME" '.version = $tag' package.json > tmp.$$.json && mv tmp.$$.json package.json
      
      - name: Commit and push changes
        run: |
          TAG_NAME=$(echo ${{github.ref_name}})
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add package.json
          git add package-lock.json
          git commit -m "Update package.json version to $TAG_NAME"
          git tag -f $TAG_NAME
          git push --force origin $TAG_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: https://registry.npmjs.org/
      
      - name: Install dependencies
        run: npm ci
      
      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.npm_token}}

